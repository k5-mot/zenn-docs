---
title: "CloudFront"
---

# CloudFrontとは？
- CloudFrontとは、AWSが提供するCDNサービス

# CDN (Contents Delivery Network)とは？
- コンテンツをキャッシュし、多くのユーザに効率的に同一コンテンツを配する仕組み。
- ユーザごとに変化しない静的なコンテンツの配信を行う、世界各地に配置されたサーバ群

# CDNの利点とは？
- サービス提供しているサーバ負荷軽減
  - 何も準備していなければ、すべてのアクセスがサービス提供事業者に集中する
  - CSS/Javascript、画像、動画などユーザごとに変化しないコンテンツ配信を別サーバ(=CDN)に委託
  - ユーザごとに変化するコンテンツ配信だけサービス事業者が提供することで、サーバ負荷の軽減ができる
- ユーザに対する応答速度向上
  - CDNサービスは、世界中にサーバを配置している
  - アクセス元から近いサーバが利用されるため、レスポンスが高速になる

# CDNの用語定義
- 静的コンテンツ
  - CSS/Javascript、画像、動画などユーザごとに変化しないコンテンツ
- 動的コンテンツ
  - リクエストごとに内容を変化させるコンテンツ
  - ユーザごとに変化させるコンテンツ
- エッジサーバ
  - キャッシュサーバ
  - サーバ側で静的コンテンツをキャッシュし最初に静的コンテンツの応答をしてくれる
  - エッジサーバは初回はオリジンサーバにアクセスする
- オリジンサーバ
  - すべてのコンテンツを保持
  - 基本はユーザごとに変化するコンテンツを配信

# CloudFrontの作成手順
1. 「CloudFront」の「ディストリビューション」を開き、「ディストリビューションを作成」
- まず、ALBのオリジンとビヘイビアを設定する
- オリジン
  - Origin domain：`elb.example.com (Route53で設定したELBのAレコードのドメイン)`
  - プロトコル：HTTPSのみ
    - Minimum Origin SSL protocol：TLSv1.2
- デフォルトのキャッシュビヘイビア
  - ビューワー
    - ビューワープロトコルポリシー：Redirect HTTP to HTTPS
    - 許可された HTTP メソッド：GET, HEAD
  - キャッシュキーとオリジンリクエスト
    - キャッシュポリシー：CachingDisable (動的コンテンツなので)
    - オリジンリクエストポリシー ：AllViewer (ヘッダをすべて流す)
- ウェブアプリケーションファイアウォール (WAF)
  - セキュリティ保護を有効にしないでください
- 設定
  - 料金クラス：すべてのエッジロケーションを使用する
    - 他の選択肢だと、バージニア北部のACMに登録したサーバ証明書が取得できない
  - 代替ドメイン名 (CNAME) ：`example.com (購入したドメインか任意のサブドメイン)`
  - カスタム SSL 証明書：ACMで発行した証明書を選択
2. 「オリジン」タブを開き、「オリジンを作成」
- 次に、S3のオリジンを作成する
- 設定
  - Origin domain：作成したS3
  - オリジンアクセス：Origin access control settings (recommended)
    - Create new OAC
      - 名前：任意の文字列
      - S3バケットに対して、バケットポリシーの変更を行うこと
3. 「ビヘイビア」タブを開き、「ビヘイビアを作成」
- 設定
  - パスパターン：`/public/* (任意のパス)`
  - オリジンとオリジングループ：作成したS3
  - ビューワー
    - ビューワープロトコルポリシー：Redirect HTTP to HTTPS
  - キャッシュキーとオリジンリクエスト
    - Cache policy and origin request policy (recommended)
      - キャッシュポリシー：CachingOptimzed
      - オリジンリクエストポリシー：CORS-S3Origin
4. Route53で、「レコードを作成」
- ルーティングポリシー：シンプルルーティング
- シンプルなレコードを定義
  - レコード名：`example.com` (任意)
  - レコードタイプ：A
  - 値/トラフィックのルーティング先：
    - CloudFrontディストリビューションへのエイリアス
    - ディストリビューション：作成したディストリビューション
5. 動作確認
  1. 右クリックメニューの「検証」をクリックし、開発者ツールを起動
  2. 「Network」タブを開く
  3. `example.com (CloudFrontに紐づけたドメイン)`の静的コンテンツをブラウザで開く。
  4. 「Network」タブの`example.com (ドメイン)`をクリック
  5. 「Headers」タブの「Response Headers」の「X-Cache」が`Miss from cloudfront`となっていることが確認できる
  6. ブラウザを閉じて開き、同様に開発者ツールを立ち上げ、ドメインをブラウザで開く。
  7. 「X-Cache」が`Hit from cloudfront`となっていることが確認できる

# CloudFrontの証明書設定
CloudFrontのCDNサーバは、世界中に存在する
CloudFrontの各種設定は、米国東部(北部バージニア)で設定すること

つまり、Webアプリ本体の東京リージョンと、CloudFrontの米国東部(北部バージニア)リージョンの２つのリージョンで、
ACM上の証明書を発行する必要がある。

- グローバル
  - CloudFront
- 日本(東京リージョン)
  - S3
  - ELB
    - EC2
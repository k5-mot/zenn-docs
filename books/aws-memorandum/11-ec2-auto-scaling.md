---
title: "EC2のAuto-Scaling"
---

サービスのユーザ数の増減に対応するために、処理性能を上げ下げする需要がある。

# 処理性能を上げる方法
- スケールアップ
  - 仮想マシンのCPUやメモリといった、スペックをあげることで処理性能を高める方法
- スケールアウト
  - 仮想マシンの台数を増やすことで処理性能を高める方法

# 処理瀬能を下げる方法
- スケールダウン
  - 仮想マシンのCPUやメモリといった、スペックを下げることで処理性能を低める方法
- スケールイン
  - 仮想マシンの台数を減らすことで処理性能を低める方法

# 処理性能の増減方向と特徴
- 垂直方向
  - スケールアップ、スケールダウン、仮想マシンのCPUやメモリといったスペックを上げ下げする方法
  - システム停止を伴うDBなどで利用
- 水平方向
  - スケールアウト、スケールイン、仮想マシンの台数を増減する方法
  - システム停止を鞆わないWeb、APなどで利用

# カスタムAMIの作成手順
- AMI (Amazon Machine Image)とは？
  - EC2のベースとなるOSイメージ
  - CPU、メモリ、ストレージ　→　　EC2インスタんす
- AMIの種類
  - コミュニティAMI
  - マーケットプレイス
  - 独自作成
- AMIのビルド/リリースプロセス
- 以下の、どこまでの範囲をテンプレート化するかによって、運用の手間、スケール時の起動の速さが変わる
  - OSの選択/起動
    - 開発の自由度は高いが、軌道から利用可能になるまでに実行する処理が多いので、急にスケールさせたくても間に合わない懸念がある
  - OS/ミドルの設定
    - OS/ミドル設定までなら、あまり変わらないので、今回はこれに実施し、テンプレート化する
  - アプリの設定
    - スケール時には起動するだけで利用可能な状態。アプリリリースの旅イメージ作成が必要なので、リリース頻度が高くなると運用が大変
  - 公開
- 今回の構成
  - ミドル
    - Node.js
    - jq
  - サービスをインストール
    - パラメータストアから環境変数を取得
    - アプリを実行するサービス

- EC2を開く
- EC2 インスタンスの作成
  - 名前とタグ
    - 名前：tastylog-dev-ap-auto-scaling-server
    - 新規タグ
      - キー：Type
      - 値：app
  - アプリケーションおよび OS イメージ (Amazon マシンイメージ)
    - Amazon マシンイメージ (AMI)：Amazon Linux 2023 AMI
  - インスタンスタイプ：t2.micro
  - キーペア：作成したキーペア
  - ネットワーク設定
    - ネットワーク：作成したVPC
    - サブネット：作成したPublic Subnet
    - パブリック IP の自動割り当て：有効化
    - ファイアウォール (セキュリティグループ)：既存のセキュリティグループを選択する
    - 共通のセキュリティグループ：
      - APPサーバ用SG
      - 運用管理用SG
  - 高度な詳細
    - IAM インスタンスプロフィール：作成したIAMロール(AWS CLIへの許可)
- EC2インスタンス内で、ミドルウェアの設定を行う(Nodeのインストール、Unitファイルの配置)
- EC2インスタンスを停止
- アクション - イメージとテンプレート - イメージを作成
  - イメージ名：tastylog-dev-app-ami
- EC2 - イメージ - AMIを開く

# アプリの設定
- 資材(アプリケーション本体)をどこからインスタンスに持ち込むのか？
- リリース方式は2種類ある
  - プッシュ式
    - 中央サーバーから新しいサーバーへ接続。構成/設定を行う。
    - 統制がやりやすい。(承認プロセス)
    - 接続 & 設定するためのアカウント/穴が新サーバー側に必要
    - 具体例：Ansible
  - プル式
    - 新しいサーバーが中央のリポジトリへ。構成/設定情報を取りに行く。
    - 新サーバー側で自動的に処理できる
    - 新サーバーから中央リポジトリへ接続するための認証情報が必要。
    - 具体例：Gitサーバ、S3
- S3に資材を配置し、プル式でオートスケーリングを設定する
1. S3に資材をアップロード
   1. バケットを作成
   - 一般的な設定
     - バケット名：tastylog-dev-deploy-bucket-by-k5mot
   - このバケットのブロックパブリックアクセス設定
     - パブリックアクセスをすべて ブロック：アンチェック
2. EC2にS3操作権限を付与 (IAMロールを修正)
   1. IAM - アクセス管理 - ロールを開く
   2. 作成したtastylog-dev-app-iam-roleを開く
   3. 許可を追加 - ポリシーをアタッチ
   4. AmazonS3ReadOnlyAccessを追加
3. S3の権限を修正
   1. 作成したバケットを開く
   2. アクセス許可 タブ
   3. バケットポリシーを編集
   - ポリシージェネレーター
     - Select Type of Policy：S3 Bucket Policy
     - Effect：Allow
     - Principal：IAMロールのARN
     - Action：GetObject
     - Amazon Resource Name (ARN)：S3のARNと、末尾に"/*"を付ける
   - 変更の保存
4. EC2の作成/起動
  - 名前とタグ
    - 名前：tastylog-dev-ap-auto-scaling-server
    - 新規タグ
      - キー：Type
      - 値：app
  - アプリケーションおよび OS イメージ (Amazon マシンイメージ)
    - 自分のAMI
      - 自己所有
      - Amazon マシンイメージ (AMI)：作成したAMI
  - インスタンスタイプ：t2.micro
  - キーペア：作成したキーペア
  - ネットワーク設定
    - ネットワーク：作成したVPC
    - サブネット：作成したPublic Subnet
    - パブリック IP の自動割り当て：有効化
    - ファイアウォール (セキュリティグループ)：既存のセキュリティグループを選択する
    - 共通のセキュリティグループ：
      - APPサーバ用SG
      - 運用管理用SG
  - 高度な詳細
    - IAM インスタンスプロフィール：作成したIAMロール(AWS CLIへの許可)
    - ユーザデータ：アプリ初期化スクリプトを設定
      - バケット名を修正
  - インスタンスを起動
5. ローカルのブラウザからアクセス
  - `http://[EC2のPublic IP]:3000/`

# オートスケールの設定
- ELBが抱えるターゲットグループに紐づけて設定する
- Auto-Scalingグループ ... オートスケールの台数、タイミングの設定
  - 起動テンプレート ... スケールアウト時に起動するEC2の設定、(こちらが推奨)
  - 起動設定
- 起動テンプレート
  - AMIの選択
  - IAMロールの選択
  - ユーザーデータの指定 (起動時に実行するスクリプトはユーザーデータで指定する)
  - セキュリティグループの設定
  - キーペアの選択


# 起動テンプレートの作成

1. EC2  インスタンス - 起動テンプレート
  - 起動テンプレート名：tastylog-dev-app-lt (launch template)
  - Auto Scaling のガイダンス
    - EC2 Auto Scaling で使用できるテンプレートをセットアップする際に役立つガイダンスを提供：チェック
  - アプリケーションおよび OS イメージ (Amazon マシンイメージ)
    - 自分のAMI
      - 自己所有
      - Amazon マシンイメージ (AMI)：作成したやつ
    - キーペア：作成したやつ
  - ネットワーク設定
    - サブネット：作成したPublic Subnet
    - 高度なネットワーク設定
      - パブリック IP の自動割り当て：有効化
      - セキュリティグループ：作成したAPサーバ用SG
  - リソースタグ
    - キー：Type
    - 値：app
  - 高度な詳細
    - IAM インスタンスプロフィール：作成したIAMロール
    - ユーザデーター：アプリ初期化スクリプトを設定
      - バケット名を修正

# オートスケールの設定
- オートスケールの仕組み
  - ELBのターゲットグループとAuto-scalingグループは一致させられる
  - CloudWatchでAuto-scalingグループを監視
  - 特定のメトリクス越えを検知
  - Auto-scalingグループへ発報して、スケールアウト・スケールイン
- アラームの設定
  - CPUが昼に頻繁に利用される場合
    - 70%以上のCPU使用率で、スケールアウト
    - 50%以下になると、スケールイン
    - スケールアウトとスケールインの閾値は、増減の揺れを避けるため、ずらして(間を持たせて)設定する
      - AWS側で自動設定できる
1. ELBのターゲットグループにあるEC2を全削除
2. オートスケールを設定
  1. EC2 - Auto Scaling - Auto Scaling グループを開く
  2. Auto Scaling グループを作成する
    - 名前：tastylog-dev-app-asg
    - 起動テンプレート：作成したLT
  3. インスタンス起動オプションを選択する
  - インスタンスタイプの要件
    - 手動でインスタンスタイプを追加する
    - プライマリインスタンスタイプ：t2.nano (負荷をかけるのが面倒なため)
    - 追加のインスタンスタイプ：全削除する
  - ネットワーク
    - VPC：作成したVPC
    - アベイラビリティーゾーンとサブネット：Public Subnet２つ
  4. 詳細オプションを設定する
  - ロードバランシング
    - 既存のロードバランサーにアタッチする
    - ロードバランサーのターゲットグループから選択する
    - 既存のロードバランサーターゲットグループ：作成したTG
  5. グループサイズとスケーリングを設定する
  - グループサイズ
    - 希望するキャパシティ：1
  - スケーリング
    - 最小の希望する容量：1
    - 最大の希望する容量：2
    - 自動スケーリング：ターゲット追跡スケーリングポリシー
    - スケーリングポリシー名：tastylog-dev-ec2-cpu-high-sp
    - ターゲット値：5 (負荷試験のため)
  - インスタンスのスケールイン保護：アンチェック
    - スケールインした仮想マシンのログを残すためのもの
  6. 通知を追加する
  7. タグを追加する
  8. Auto Scalingグループを作成する
3. EC2の自動起動を確認
  - EC2のインスタンスを開き、自動起動されているか確認
  - ターゲットグループを開き、自動起動したEC2が所属しているか確認

# オートスケールの動作確認 (時間と課金が結構かかる)
1. JMeterを利用して、ELBに対して負荷をかける (CloudFront経由でなく、直接ALBにアクセスする)
  - EC2が自動的に起動されるのを確認
    - インスタンスを開き、VPC IDで検索する
    - CloudWatchでアラーム(スケールアウト/インで発報される)とメトリクスを確認する
    - メトリクスのEc2 - autoscaling グループ - CPUUtilicationをチェック
    - Ec2 - CPUUtilizationをチェック
    - jmeter.batを起動、シナリオを開く
    - TEST planのHOST_NAMEをELBのドメイン名に変更
      - Thread Group：どれくらいの負荷をかけるかの設定
      - シナリオの中身：検索 → お店を開く → (100回)
    - メトリクス(自動更新設定にする)・アラーム・インスタンスのページを見えるようにして、JMeterで負荷をかける
    - 負荷をかけると、メトリクス(CPU使用率の上昇)→アラーム発報→別のインスタンス起動となる。
2. JMeterを停止して負荷を下げる
  - EC2が自動的に停止されるのを確認
    - 負荷がかけ終わると、メトリクス(CPU使用率の現象)→アラーム発報→インスタンス終了１となる。
